name: Build Buddy APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./buddy_assistant
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Build and Verify
        run: |
          # 1. Setup Android SDK Tools explicitly
          # Ubuntu runners have SDK, but sometimes missing specific tools Flutter wants.
          echo "Updating Android SDK..."
          yes | sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          
          # 2. Accept Licenses
          yes | flutter doctor --android-licenses || true
          
          # 3. Precache Android Artifacts (Forces Flutter to download Gradle wrapper etc)
          flutter precache --android
          
          # 4. Configure Environment
          flutter config --no-analytics
          flutter config --enable-android
          flutter doctor -v
          
          # 5. Create Project (Explicitly 'app' template)
          # We use a standard name 'build_env'
          flutter create build_env --template=app --org com.example --project-name buddy_assistant --platforms android
          
          # 6. Debug Output
          echo "Checking build_env/android structure:"
          ls -R build_env/android || echo "Android folder missing!"
          
          # 7. Fail Fast
          if [ ! -f "build_env/android/app/build.gradle" ]; then
             echo "CRITICAL: build.gradle is missing. Scaffolding failed."
             exit 1
          fi
          
          # 8. Merge Code
          rm -rf build_env/lib
          cp -r lib build_env/
          cp -r assets build_env/
          cp pubspec.yaml build_env/
          
          # Ensure directories exist
          mkdir -p build_env/android/app/src/main
          
          # Merge Native Code
          cp -r android/app/src/main/* build_env/android/app/src/main/
          
          # 9. Inject Dependencies
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' build_env/android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' build_env/android/app/build.gradle
          
          # 10. Build
          cd build_env
          flutter pub get
          flutter build apk --debug
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: buddy_assistant/build_env/build/app/outputs/flutter-apk/app-debug.apk
