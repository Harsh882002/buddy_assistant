name: Build Buddy APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./buddy_assistant
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Setup Tools and Build
        run: |
          # 1. Setup Environment Variables
          echo "Configuring Android Environment..."
          export JAVA_HOME=$JAVA_HOME_17_X64
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          
          # 2. Accept Licenses (Force)
          echo "Accepting Licenses..."
          yes | flutter doctor --android-licenses || true
          
          # 3. Configure Flutter
          flutter config --no-analytics
          flutter config --enable-android
          
          # 4. Check Doctor (Verbose)
          flutter doctor -v
          
          # 5. Create Fresh Build Folder
          echo "Creating fresh_build..."
          # We try creating it. If Android fails, we will see it in the logs.
          flutter create fresh_build --org com.example --project-name buddy_assistant --platforms android
          
          # 6. Verify Creation
          if [ ! -d "fresh_build/android" ]; then
             echo "#############################################"
             echo "ERROR: Android folder missing!"
             echo "Listing fresh_build contents:"
             ls -R fresh_build
             echo "#############################################"
             exit 1
          fi
          
          # 7. Merge Code
          echo "Merging code..."
          rm -rf fresh_build/lib
          cp -r lib fresh_build/
          cp -r assets fresh_build/
          cp pubspec.yaml fresh_build/
          
          # Ensure target dir exists
          mkdir -p fresh_build/android/app/src/main
          # Copy native source
          cp -r android/app/src/main/* fresh_build/android/app/src/main/
          
          # 8. Inject Dependencies
          echo "Injecting Gradle dependencies..."
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' fresh_build/android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' fresh_build/android/app/build.gradle
          
          # 9. Build APK
          echo "Building APK..."
          cd fresh_build
          flutter pub get
          flutter build apk --debug --verbose
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: buddy_assistant/fresh_build/build/app/outputs/flutter-apk/app-debug.apk
