name: Build Buddy APK
on: [push]
jobs:
  build:
    # Use a pre-configured Docker container with everything installed.
    # This is the "Nuclear Option" for stability.
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/cirruslabs/flutter:stable
      
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      # Fix permission issues that sometimes happen in containers
      - name: Fix Directory Permissions
        run: git config --global --add safe.directory '*'
      
      - name: Build and Verify
        run: |
          # 1. Verify Environment (Everything should be pre-installed)
          flutter doctor -v
          
          # 2. Create Project
          # Using the container, this MUST work.
          flutter create build_env --org com.example --project-name buddy_assistant --platforms android
          
          # 3. Migrate Code
          echo "Migrating Source Code..."
          
          # Clean default lib
          rm -rf build_env/lib
          
          # Copy our code (buddy_assistant is at root now because we moved .github up)
          # Wait, in the docker container, the checkout path might be different?
          # Standard checkout puts files in $GITHUB_WORKSPACE.
          # We operate relative to that.
          
          cp -r buddy_assistant/lib build_env/
          cp -r buddy_assistant/assets build_env/
          cp buddy_assistant/pubspec.yaml build_env/
          
          # Merge Native Code
          # Ensure target dir exists
          mkdir -p build_env/android/app/src/main
          cp -r buddy_assistant/android/app/src/main/* build_env/android/app/src/main/
          
          # 4. Inject Dependencies
          echo "Injecting Dependencies..."
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' build_env/android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' build_env/android/app/build.gradle
          
          # 5. Build
          echo "Building..."
          cd build_env
          flutter pub get
          flutter build apk --debug
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: build_env/build/app/outputs/flutter-apk/app-debug.apk
