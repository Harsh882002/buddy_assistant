name: Build Buddy APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./buddy_assistant
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Build and Verify
        run: |
          # 1. Accept Licenses
          yes | flutter doctor --android-licenses || true
          
          # 2. Configure Environment
          flutter config --enable-android
          flutter doctor -v
          
          # 3. Create Project
          # We purposefully do NOT use "fresh_build" as a name if it causes path issues, 
          # but we will stick to it for consistency with previous attempts. 'fresh' is cleaner.
          flutter create fresh --project-name buddy_assistant --platforms android
          
          # 4. Debug Output
          echo "Checking fresh/android structure:"
          ls -R fresh/android || echo "Android folder missing!"
          
          # 5. Fail Fast
          if [ ! -f "fresh/android/app/build.gradle" ]; then
             echo "CRITICAL: build.gradle is missing. Scaffolding failed."
             exit 1
          fi
          
          # 6. Merge Code
          rm -rf fresh/lib
          cp -r lib fresh/
          cp -r assets fresh/
          cp pubspec.yaml fresh/
          
          # Ensure directories exist
          mkdir -p fresh/android/app/src/main
          
          # Merge Native Code
          # Using cp -rT to merge contents if supported, or just standard cp -r
          cp -r android/app/src/main/* fresh/android/app/src/main/
          
          # 7. Inject Dependencies
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' fresh/android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' fresh/android/app/build.gradle
          
          # 8. Build
          cd fresh
          flutter pub get
          flutter build apk --debug
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: buddy_assistant/fresh/build/app/outputs/flutter-apk/app-debug.apk
