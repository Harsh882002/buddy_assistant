name: Build Buddy APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./buddy_assistant
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - run: flutter pub get
      
      # Adding a dummy key.properties if needed, but for debug release it's optional.
      # We are building release but unsigned (or signed with debug key by default if not specified).
      # For simplicity we'll let Flutter use the default debug signing for the release build 
      # or we can just build apk --debug if strict release signing is an issue.
      # However, "flutter build apk --release" works fine with default keys for personal use.
      - run: flutter pub get
      
      - name: Setup and Build
        run: |
          # 1. Diagnostics: Why is Android missing?
          flutter doctor -v
          
          # 2. Configure & Create (Force Android)
          flutter config --enable-android
          flutter create fresh_build --org com.example --project-name buddy_assistant --platforms android
          
          # Debug: Verify structure
          ls -R fresh_build
          
          # 3. Copy OUR code into the fresh project
          # Overwrite lib
          rm -rf fresh_build/lib
          cp -r lib fresh_build/
          
          # Copy assets
          cp -r assets fresh_build/
          
          # Overwrite pubspec
          cp pubspec.yaml fresh_build/
          
          # Merge Android Native Code
          # We primarily want to overwrite AndroidManifest and add our Kotlin files.
          # The structure in our repo: android/app/src/main/...
          # The target: fresh_build/android/app/src/main/...
          # We force copy to ensure we update the generated files
          cp -r android/app/src/main/* fresh_build/android/app/src/main/
          
          # 3. Inject Dependencies (into the FRESH project)
          # Now we are sure build.gradle exists because it's a fresh create.
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' fresh_build/android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' fresh_build/android/app/build.gradle
          
          # 4. Build
          cd fresh_build
          flutter pub get
          flutter build apk --debug
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: buddy_assistant/fresh_build/build/app/outputs/flutter-apk/app-debug.apk
