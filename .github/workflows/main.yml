name: Build Buddy APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          log-warning: false

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Build and Verify
        run: |
          # 1. Environment & Tools
          yes | flutter doctor --android-licenses || true
          flutter config --no-analytics
          flutter config --enable-android
          flutter doctor -v
          
          # 2. Create Clean Project (Sibling to 'buddy_assistant')
          # structure:
          #   / (root)
          #   ├── buddy_assistant/ (YOUR CODE)
          #   └── android_build/   (FRESH APP)
          
          echo "Creating fresh project..."
          flutter create android_build --template=app --org com.example --project-name buddy_assistant --platforms android -v > create.log 2>&1 || (cat create.log && exit 1)
          
          # 3. Verify Scaffolding
          if [ ! -f "android_build/android/app/build.gradle" ]; then
             echo "CRITICAL: build.gradle missing!"
             cat create.log
             ls -R android_build
             exit 1
          fi
          
          # 4. Migrate Code (Copy from buddy_assistant -> android_build)
          echo "Migrating Source Code..."
          
          # Lib
          rm -rf android_build/lib
          cp -r buddy_assistant/lib android_build/
          
          # Assets
          cp -r buddy_assistant/assets android_build/
          
          # Pubspec
          cp buddy_assistant/pubspec.yaml android_build/
          
          # Native Code configuration
          mkdir -p android_build/android/app/src/main
          cp -r buddy_assistant/android/app/src/main/* android_build/android/app/src/main/
          
          # 5. Inject Dependencies
          echo "Injecting Gradle Dependencies..."
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' android_build/android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' android_build/android/app/build.gradle
          
          # 6. Build
          echo "Building..."
          cd android_build
          flutter pub get
          flutter build apk --debug
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: android_build/build/app/outputs/flutter-apk/app-debug.apk
