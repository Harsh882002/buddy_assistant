name: Build Buddy APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./buddy_assistant
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # RELIABLE SDK SETUP
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          log-warning: false

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Build and Verify
        run: |
          # 1. Accept Licenses
          yes | flutter doctor --android-licenses || true
          
          # 2. Precache Android Artifacts
          flutter precache --android
          
          # 3. Configure Environment
          flutter config --no-analytics
          flutter config --enable-android
          flutter doctor -v
          
          # 4. Create Project
          flutter create build_env --template=app --org com.example --project-name buddy_assistant --platforms android
          
          # 5. Debug Output
          echo "Checking build_env/android structure:"
          ls -R build_env/android || echo "Android folder missing!"
          
          # 6. Fail Fast
          if [ ! -f "build_env/android/app/build.gradle" ]; then
             echo "CRITICAL: build.gradle is missing. Scaffolding failed."
             exit 1
          fi
          
          # 7. Merge Code
          rm -rf build_env/lib
          cp -r lib build_env/
          cp -r assets build_env/
          cp pubspec.yaml build_env/
          
          # Ensure directories exist
          mkdir -p build_env/android/app/src/main
          
          # Merge Native Code
          cp -r android/app/src/main/* build_env/android/app/src/main/
          
          # 8. Inject Dependencies
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' build_env/android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' build_env/android/app/build.gradle
          
          # 9. Build
          cd build_env
          flutter pub get
          flutter build apk --debug
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: buddy_assistant/build_env/build/app/outputs/flutter-apk/app-debug.apk
