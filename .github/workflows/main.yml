name: Build Buddy APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./buddy_assistant
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - run: flutter pub get
      
      # Adding a dummy key.properties if needed, but for debug release it's optional.
      # We are building release but unsigned (or signed with debug key by default if not specified).
      # For simplicity we'll let Flutter use the default debug signing for the release build 
      # or we can just build apk --debug if strict release signing is an issue.
      # However, "flutter build apk --release" works fine with default keys for personal use.
      - run: flutter pub get
      
      # SCAFFOLDING MAGIC:
      - name: Scaffold Project
        run: |
          # Debug initial state
          ls -R
          
          # 1. Back up our custom code
          mkdir temp_custom
          mv lib temp_custom/
          mv android temp_custom/
          mv pubspec.yaml temp_custom/
          mv assets temp_custom/
          
          # 2. Scaffolding: Create fresh flutter app
          flutter create . --org com.example --project-name buddy_assistant --platforms android
          
          # Debug after scaffold
          ls -R
          
          # 3. Clean generic code
          rm -rf lib test
          
          # 4. Restore/Merge our code
          # Restore lib (folder replacement)
          cp -r temp_custom/lib .
          # Restore assets (folder replacement)
          cp -r temp_custom/assets .
          # Restore pubspec (file replacement)
          cp temp_custom/pubspec.yaml .
          
          # Merge Android (files inside folders)
          # We copy contents of temp_custom/android into current android/
          cp -r temp_custom/android/. android/
          
      # DEPENDENCY INJECTION:
      - name: Inject Vosk Dependency
        run: |
          # Verify file exists
          ls -l android/app/build.gradle
          
          # Inject Dependencies
          sed -i 's/dependencies {/dependencies {\n    implementation "com.alphacephei:vosk-android:0.3.30"/' android/app/build.gradle
          sed -i 's/defaultConfig {/defaultConfig {\n        multiDexEnabled true/' android/app/build.gradle

      - run: flutter pub get
      - run: flutter build apk --debug
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buddy-assistant-release
          path: build/app/outputs/flutter-apk/app-debug.apk
